<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visitas Ocultas</title>
    <link rel="stylesheet" href="visitas_ocultas.css" />
  </head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <body>
    <button class="hidden-button" onclick="showPasswordPrompt()">.</button>

    <div id="passwordPrompt">
      <h2>Ingrese la clave secreta</h2>
      <input type="password" id="password" placeholder="Clave secreta" />
      <button onclick="validatePassword()">Entrar</button>
      <p id="errorMessage">Clave incorrecta</p>
    </div>

    <div id="dashboard" class="hidden">
      <h2>Visitas de Usuarios</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>NOMBRE</th>
              <th>EMAIL</th>
              <th>TELÉFONO</th>
              <th>VISITAS</th>
              <th>ESTATUS</th>
            </tr>
          </thead>
          <tbody id="userTable">
            <!-- Los datos se llenarán dinámicamente -->
          </tbody>
        </table>
      </div>
      <canvas id="visitChart" width="600" height="400"></canvas>
      <button id="downloadExcel" class="download-btn">
        Descargar en Excel
      </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const secretKey = "admin"; // Clave secreta
      let users = []; // Definimos la variable 'users' globalmente

      function showPasswordPrompt() {
        document.getElementById("passwordPrompt").style.display = "block";
      }

      function validatePassword() {
        const inputPassword = document.getElementById("password").value;
        if (inputPassword === secretKey) {
          document.getElementById("passwordPrompt").style.display = "none";
          document.getElementById("dashboard").style.display = "block";
          loadUserData();
        } else {
          document.getElementById("errorMessage").style.display = "block";
        }
      }

      function loadUserData() {
        fetch("get_users.php")
          .then((response) => response.json())
          .then((data) => {
            console.log(data); // <-- Agrega esto para ver los datos en la consola
            users = data;
            populateTable(users);
            loadChart(users);
          })
          .catch((error) => {
            console.error("Error al cargar los datos:", error);
          });
      }

      function populateTable(users) {
        const userTable = document.getElementById("userTable");
        userTable.innerHTML = ""; // Limpiar la tabla antes de insertar nuevos datos

        users.forEach((user) => {
          // Verificar si el estado de la transacción está definido
          let estado = user.estado_transaccion
            ? user.estado_transaccion
            : "Sin información";

          // Determinar el color de la fila según el estado de la transacción
          let rowColor = estado === "compra realizada" ? "#D4EDDA" : "#F8D7DA"; // Verde para compra, rojo para no compra

          const row = `
        <tr style="background-color: ${rowColor};">
            <td>${user.nombre}</td>
            <td>${user.email}</td>
            <td>${user.telefono}</td>
            <td>${user.visitas}</td>
            <td>${estado}</td>
        </tr>`;

          userTable.innerHTML += row;
        });
      }

      function loadChart(users) {
        const ctx = document.getElementById("visitChart").getContext("2d");

        // Agrupar visitas por fecha
        const visitCounts = {};
        users.forEach((user) => {
          if (visitCounts[user.ultima_visita]) {
            visitCounts[user.ultima_visita] += parseInt(user.visitas);
          } else {
            visitCounts[user.ultima_visita] = parseInt(user.visitas);
          }
        });

        const labels = Object.keys(visitCounts);
        const visitData = Object.values(visitCounts);

        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Visitas por Fecha",
                data: visitData,
                backgroundColor: "rgba(153, 102, 255, 0.2)",
                borderColor: "rgba(153, 102, 255, 1)",
                borderWidth: 2,
                tension: 0.4,
                pointBackgroundColor: "rgba(153, 102, 255, 1)",
              },
            ],
          },
          options: {
            scales: {
              x: {
                ticks: {
                  autoSkip: true,
                  maxTicksLimit: 10,
                },
              },
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      document
        .getElementById("downloadExcel")
        .addEventListener("click", function () {
          const workbook = XLSX.utils.book_new();
          const table = document.querySelector("table");
          const worksheet = XLSX.utils.table_to_sheet(table, { raw: true });

          // Aplicar formato a los encabezados
          const range = XLSX.utils.decode_range(worksheet["!ref"]);
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = XLSX.utils.encode_cell({ r: 0, c: C });
            if (!worksheet[cell_address]) continue;

            worksheet[cell_address].s = {
              font: { bold: true, color: { rgb: "FFFFFF" }, sz: 14 },
              fill: { fgColor: { rgb: "7B1FA2" } },
              alignment: { horizontal: "center", vertical: "center" },
            };
          }

          // Aplicar formato a las celdas de datos
          for (let R = 1; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
              const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
              if (!worksheet[cell_address]) continue;

              worksheet[cell_address].s = {
                alignment: { horizontal: "center", vertical: "center" },
              };
            }
          }

          // Ajustar el ancho de las columnas
          worksheet["!cols"] = [
            { wch: 20 }, // Nombre
            { wch: 30 }, // Email
            { wch: 15 }, // Teléfono
            { wch: 10 }, // Visitas
          ];

          // Guardar archivo
          XLSX.utils.book_append_sheet(workbook, worksheet, "Visitas");
          XLSX.writeFile(workbook, "visitas_usuarios.xlsx");
        });
    </script>
  </body>
</html>
